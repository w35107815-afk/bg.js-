var LITE_EXTENSION = false; (function(t, e) { "use strict"; if (typeof module === "object" && module.exports) { module.exports = e(require("./punycode"), require("./IPv6"), require("./SecondLevelDomains")); } else if (typeof define === "function" && define.amd) { define([ "./punycode", "./IPv6", "./SecondLevelDomains" ], e); } else { t.URI = e(t.punycode, t.IPv6, t.SecondLevelDomains, t); } })(this, function(f, e, o, r) { "use strict"; var i = r && r.URI; function m(t, e) { var r = arguments.length >= 1; var i = arguments.length >= 2; if (!(this instanceof m)) { if (r) { if (i) { return new m(t, e); } return new m(t); } return new m(); } if (t === undefined) { if (r) { throw new TypeError("undefined is not a valid argument for URI"); } if (typeof location !== "undefined") { t = location.href + ""; } else { t = ""; } } if (t === null) { if (r) { throw new TypeError("null is not a valid argument for URI"); } } this.href(t); if (e !== undefined) { return this.absoluteTo(e); } return this; } function n(t) { return /^[0-9]+$/.test(t); } m.version = "1.19.0"; var t = m.prototype; var h = Object.prototype.hasOwnProperty; function a(t) { return t.replace(/([.*+?^=!:${}()|[\]\/\\])/g, "\\$1"); } function c(t) { if (t === undefined) { return "Undefined"; } return String(Object.prototype.toString.call(t)).slice(8, -1); } function l(t) { return c(t) === "Array"; } function u(t, e) { var r = {}; var i, n; if (c(e) === "RegExp") { r = null; } else if (l(e)) { for (i = 0, n = e.length; i < n; i++) { r[e[i]] = true; } } else { r[e] = true; } for (i = 0, n = t.length; i < n; i++) { var s = r && r[t[i]] !== undefined || !r && e.test(t[i]); if (s) { t.splice(i, 1); n--; i--; } } return t; } function d(t, e) { var r, i; if (l(e)) { for (r = 0, i = e.length; r < i; r++) { if (!d(t, e[r])) { return false; } } return true; } var n = c(e); for (r = 0, i = t.length; r < i; r++) { if (n === "RegExp") { if (typeof t[r] === "string" && t[r].match(e)) { return true; } } else if (t[r] === e) { return true; } } return false; } function v(t, e) { if (!l(t) || !l(e)) { return false; } if (t.length !== e.length) { return false; } t.sort(); e.sort(); for (var r = 0, i = t.length; r < i; r++) { if (t[r] !== e[r]) { return false; } } return true; } function p(t) { var e = /^\/+|\/+$/g; return t.replace(e, ""); } m._parts = function() { return { protocol: null, username: null, password: null, hostname: null, urn: null, port: null, path: null, query: null, fragment: null, preventInvalidHostname: m.preventInvalidHostname, duplicateQueryParameters: m.duplicateQueryParameters, escapeQuerySpace: m.escapeQuerySpace }; }; m.preventInvalidHostname = false; m.duplicateQueryParameters = false; m.escapeQuerySpace = true; m.protocol_expression = /^[a-z][a-z0-9.+-]*$/i; m.idn_expression = /[^a-z0-9\._-]/i; m.punycode_expression = /(xn--)/i; m.ip4_expression = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/; m.ip6_expression = /^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/; m.find_uri_expression = /\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/gi; m.findUri = { start: /\b(?:([a-z][a-z0-9.+-]*:\/\/)|www\.)/gi, end: /[\s\r\n]|$/, trim: /[`!()\[\]{};:'".,<>?«»“”„‘’]+$/, parens: /(\([^\)]*\)|\[[^\]]*\]|\{[^}]*\}|<[^>]*>)/g }; m.defaultPorts = { http: "80", https: "443", ftp: "21", gopher: "70", ws: "80", wss: "443" }; m.hostProtocols = [ "http", "https" ]; m.invalid_hostname_characters = /[^a-zA-Z0-9\.\-:_]/; m.domAttributes = { a: "href", blockquote: "cite", link: "href", base: "href", script: "src", form: "action", img: "src", area: "href", iframe: "src", embed: "src", source: "src", track: "src", input: "src", audio: "src", video: "src" }; m.getDomAttribute = function(t) { if (!t || !t.nodeName) { return undefined; } var e = t.nodeName.toLowerCase(); if (e === "input" && t.type !== "image") { return undefined; } return m.domAttributes[e]; }; function s(t) { return escape(t); } function g(t) { return encodeURIComponent(t).replace(/[!'()*]/g, s).replace(/\*/g, "%2A"); } m.encode = g; m.decode = decodeURIComponent; m.iso8859 = function() { m.encode = escape; m.decode = unescape; }; m.unicode = function() { m.encode = g; m.decode = decodeURIComponent; }; m.characters = { pathname: { encode: { expression: /%(24|26|2B|2C|3B|3D|3A|40)/gi, map: { "%24": "$", "%26": "&", "%2B": "+", "%2C": ",", "%3B": ";", "%3D": "=", "%3A": ":", "%40": "@" } }, decode: { expression: /[\/\?#]/g, map: { "/": "%2F", "?": "%3F", "#": "%23" } } }, reserved: { encode: { expression: /%(21|23|24|26|27|28|29|2A|2B|2C|2F|3A|3B|3D|3F|40|5B|5D)/gi, map: { "%3A": ":", "%2F": "/", "%3F": "?", "%23": "#", "%5B": "[", "%5D": "]", "%40": "@", "%21": "!", "%24": "$", "%26": "&", "%27": "'", "%28": "(", "%29": ")", "%2A": "*", "%2B": "+", "%2C": ",", "%3B": ";", "%3D": "=" } } }, urnpath: { encode: { expression: /%(21|24|27|28|29|2A|2B|2C|3B|3D|40)/gi, map: { "%21": "!", "%24": "$", "%27": "'", "%28": "(", "%29": ")", "%2A": "*", "%2B": "+", "%2C": ",", "%3B": ";", "%3D": "=", "%40": "@" } }, decode: { expression: /[\/\?#:]/g, map: { "/": "%2F", "?": "%3F", "#": "%23", ":": "%3A" } } } }; m.encodeQuery = function(t, e) { var r = m.encode(t + ""); if (e === undefined) { e = m.escapeQuerySpace; } return e ? r.replace(/%20/g, "+") : r; }; m.decodeQuery = function(e, t) { e += ""; if (t === undefined) { t = m.escapeQuerySpace; } try { return m.decode(t ? e.replace(/\+/g, "%20") : e); } catch (t) { return e; } }; var w = { encode: "encode", decode: "decode" }; var y; var b = function(r, i) { return function(e) { try { return m[i](e + "").replace(m.characters[r][i].expression, function(t) { return m.characters[r][i].map[t]; }); } catch (t) { return e; } }; }; for (y in w) { m[y + "PathSegment"] = b("pathname", w[y]); m[y + "UrnPathSegment"] = b("urnpath", w[y]); } var x = function(s, u, f) { return function(t) { var e; if (!f) { e = m[u]; } else { e = function(t) { return m[u](m[f](t)); }; } var r = (t + "").split(s); for (var i = 0, n = r.length; i < n; i++) { r[i] = e(r[i]); } return r.join(s); }; }; m.decodePath = x("/", "decodePathSegment"); m.decodeUrnPath = x(":", "decodeUrnPathSegment"); m.recodePath = x("/", "encodePathSegment", "decode"); m.recodeUrnPath = x(":", "encodeUrnPathSegment", "decode"); m.encodeReserved = b("reserved", "encode"); m.parse = function(t, e) { var r; if (!e) { e = { preventInvalidHostname: m.preventInvalidHostname }; } r = t.indexOf("#"); if (r > -1) { e.fragment = t.substring(r + 1) || null; t = t.substring(0, r); } r = t.indexOf("?"); if (r > -1) { e.query = t.substring(r + 1) || null; t = t.substring(0, r); } if (t.substring(0, 2) === "//") { e.protocol = null; t = t.substring(2); t = m.parseAuthority(t, e); } else { r = t.indexOf(":"); if (r > -1) { e.protocol = t.substring(0, r) || null; if (e.protocol && !e.protocol.match(m.protocol_expression)) { e.protocol = undefined; } else if (t.substring(r + 1, r + 3) === "//") { t = t.substring(r + 3); t = m.parseAuthority(t, e); } else { t = t.substring(r + 1); e.urn = true; } } } e.path = t; return e; }; m.parseHost = function(t, e) { if (!t) { t = ""; } t = t.replace(/\\/g, "/"); var r = t.indexOf("/"); var i; var n; if (r === -1) { r = t.length; } if (t.charAt(0) === "[") { i = t.indexOf("]"); e.hostname = t.substring(1, i) || null; e.port = t.substring(i + 2, r) || null; if (e.port === "/") { e.port = null; } } else { var s = t.indexOf(":"); var u = t.indexOf("/"); var f = t.indexOf(":", s + 1); if (f !== -1 && (u === -1 || f < u)) { e.hostname = t.substring(0, r) || null; e.port = null; } else { n = t.substring(0, r).split(":"); e.hostname = n[0] || null; e.port = n[1] || null; } } if (e.hostname && t.substring(r).charAt(0) !== "/") { r++; t = "/" + t; } if (e.preventInvalidHostname) { m.ensureValidHostname(e.hostname, e.protocol); } if (e.port) { m.ensureValidPort(e.port); } return t.substring(r) || "/"; }; m.parseAuthority = function(t, e) { t = m.parseUserinfo(t, e); return m.parseHost(t, e); }; m.parseUserinfo = function(t, e) { var r = t.indexOf("/"); var i = t.lastIndexOf("@", r > -1 ? r : t.length - 1); var n; if (i > -1 && (r === -1 || i < r)) { n = t.substring(0, i).split(":"); e.username = n[0] ? m.decode(n[0]) : null; n.shift(); e.password = n[0] ? m.decode(n.join(":")) : null; t = t.substring(i + 1); } else { e.username = null; e.password = null; } return t; }; m.parseQuery = function(t, e) { if (!t) { return {}; } t = t.replace(/&+/g, "&").replace(/^\?*&*|&+$/g, ""); if (!t) { return {}; } var r = {}; var i = t.split("&"); var n = i.length; var s, u, f; for (var a = 0; a < n; a++) { s = i[a].split("="); u = m.decodeQuery(s.shift(), e); f = s.length ? m.decodeQuery(s.join("="), e) : null; if (h.call(r, u)) { if (typeof r[u] === "string" || r[u] === null) { r[u] = [ r[u] ]; } r[u].push(f); } else { r[u] = f; } } return r; }; m.build = function(t) { var e = ""; if (t.protocol) { e += t.protocol + ":"; } if (!t.urn && (e || t.hostname)) { e += "//"; } e += m.buildAuthority(t) || ""; if (typeof t.path === "string") { if (t.path.charAt(0) !== "/" && typeof t.hostname === "string") { e += "/"; } e += t.path; } if (typeof t.query === "string" && t.query) { e += "?" + t.query; } if (typeof t.fragment === "string" && t.fragment) { e += "#" + t.fragment; } return e; }; m.buildHost = function(t) { var e = ""; if (!t.hostname) { return ""; } else if (m.ip6_expression.test(t.hostname)) { e += "[" + t.hostname + "]"; } else { e += t.hostname; } if (t.port) { e += ":" + t.port; } return e; }; m.buildAuthority = function(t) { return m.buildUserinfo(t) + m.buildHost(t); }; m.buildUserinfo = function(t) { var e = ""; if (t.username) { e += m.encode(t.username); } if (t.password) { e += ":" + m.encode(t.password); } if (e) { e += "@"; } return e; }; m.buildQuery = function(t, e, r) { var i = ""; var n, s, u, f; for (s in t) { if (h.call(t, s) && s) { if (l(t[s])) { n = {}; for (u = 0, f = t[s].length; u < f; u++) { if (t[s][u] !== undefined && n[t[s][u] + ""] === undefined) { i += "&" + m.buildQueryParameter(s, t[s][u], r); if (e !== true) { n[t[s][u] + ""] = true; } } } } else if (t[s] !== undefined) { i += "&" + m.buildQueryParameter(s, t[s], r); } } } return i.substring(1); }; m.buildQueryParameter = function(t, e, r) { return m.encodeQuery(t, r) + (e !== null ? "=" + m.encodeQuery(e, r) : ""); }; m.addQuery = function(t, e, r) { if (typeof e === "object") { for (var i in e) { if (h.call(e, i)) { m.addQuery(t, i, e[i]); } } } else if (typeof e === "string") { if (t[e] === undefined) { t[e] = r; return; } else if (typeof t[e] === "string") { t[e] = [ t[e] ]; } if (!l(r)) { r = [ r ]; } t[e] = (t[e] || []).concat(r); } else { throw new TypeError("URI.addQuery() accepts an object, string as the name parameter"); } }; m.setQuery = function(t, e, r) { if (typeof e === "object") { for (var i in e) { if (h.call(e, i)) { m.setQuery(t, i, e[i]); } } } else if (typeof e === "string") { t[e] = r === undefined ? null : r; } else { throw new TypeError("URI.setQuery() accepts an object, string as the name parameter"); } }; m.removeQuery = function(t, e, r) { var i, n, s; if (l(e)) { for (i = 0, n = e.length; i < n; i++) { t[e[i]] = undefined; } } else if (c(e) === "RegExp") { for (s in t) { if (e.test(s)) { t[s] = undefined; } } } else if (typeof e === "object") { for (s in e) { if (h.call(e, s)) { m.removeQuery(t, s, e[s]); } } } else if (typeof e === "string") { if (r !== undefined) { if (c(r) === "RegExp") { if (!l(t[e]) && r.test(t[e])) { t[e] = undefined; } else { t[e] = u(t[e], r); } } else if (t[e] === String(r) && (!l(r) || r.length === 1)) { t[e] = undefined; } else if (l(t[e])) { t[e] = u(t[e], r); } } else { t[e] = undefined; } } else { throw new TypeError("URI.removeQuery() accepts an object, string, RegExp as the first parameter"); } }; m.hasQuery = function(t, e, r, i) { switch (c(e)) { case "String": break; case "RegExp": for (var n in t) { if (h.call(t, n)) { if (e.test(n) && (r === undefined || m.hasQuery(t, n, r))) { return true; } } } return false; case "Object": for (var s in e) { if (h.call(e, s)) { if (!m.hasQuery(t, s, e[s])) { return false; } } } return true; default: throw new TypeError("URI.hasQuery() accepts a string, regular expression or object as the name parameter"); } switch (c(r)) { case "Undefined": return e in t; case "Boolean": var u = Boolean(l(t[e]) ? t[e].length : t[e]); return r === u; case "Function": return !!r(t[e], e, t); case "Array": if (!l(t[e])) { return false; } var f = i ? d : v; return f(t[e], r); case "RegExp": if (!l(t[e])) { return Boolean(t[e] && t[e].match(r)); } if (!i) { return false; } return d(t[e], r); case "Number": r = String(r); case "String": if (!l(t[e])) { return t[e] === r; } if (!i) { return false; } return d(t[e], r); default: throw new TypeError("URI.hasQuery() accepts undefined, boolean, string, number, RegExp, Function as the value parameter"); } }; m.joinPaths = function() { var t = []; var e = []; var r = 0; for (var i = 0; i < arguments.length; i++) { var n = new m(arguments[i]); t.push(n); var s = n.segment(); for (var u = 0; u < s.length; u++) { if (typeof s[u] === "string") { e.push(s[u]); } if (s[u]) { r++; } } } if (!e.length || !r) { return new m(""); } var f = new m("").segment(e); if (t[0].path() === "" || t[0].path().slice(0, 1) === "/") { f.path("/" + f.path()); } return f.normalize(); }; m.commonPath = function(t, e) { var r = Math.min(t.length, e.length); var i; for (i = 0; i < r; i++) { if (t.charAt(i) !== e.charAt(i)) { i--; break; } } if (i < 1) { return t.charAt(0) === e.charAt(0) && t.charAt(0) === "/" ? "/" : ""; } if (t.charAt(i) !== "/" || e.charAt(i) !== "/") { i = t.substring(0, i).lastIndexOf("/"); } return t.substring(0, i + 1); }; m.withinString = function(t, h, e) { e || (e = {}); var r = e.start || m.findUri.start; var c = e.end || m.findUri.end; var l = e.trim || m.findUri.trim; var d = e.parens || m.findUri.parens; var v = /[a-z0-9-]=["']?$/i; r.lastIndex = 0; while (true) { var i = r.exec(t); if (!i) { break; } var n = i.index; if (e.ignoreHtml) { var p = t.slice(Math.max(n - 3, 0), n); if (p && v.test(p)) { continue; } } var s = n + t.slice(n).search(c); var u = t.slice(n, s); var f = -1; while (true) { var a = d.exec(u); if (!a) { break; } var g = a.index + a[0].length; f = Math.max(f, g); } if (f > -1) { u = u.slice(0, f) + u.slice(f).replace(l, ""); } else { u = u.replace(l, ""); } if (u.length <= i[0].length) { continue; } if (e.ignore && e.ignore.test(u)) { continue; } s = n + u.length; var o = h(u, n, s, t); if (o === undefined) { r.lastIndex = s; continue; } o = String(o); t = t.slice(0, n) + o + t.slice(s); r.lastIndex = n + o.length; } r.lastIndex = 0; return t; }; m.ensureValidHostname = function(t, e) { var r = !!t; var i = !!e; var n = false; if (i) { n = d(m.hostProtocols, e); } if (n && !r) { throw new TypeError("Hostname cannot be empty, if protocol is " + e); } else if (t && t.match(m.invalid_hostname_characters)) { if (!f) { throw new TypeError('Hostname "' + t + '" contains characters other than [A-Z0-9.-:_] and Punycode.js is not available'); } if (f.toASCII(t).match(m.invalid_hostname_characters)) { throw new TypeError('Hostname "' + t + '" contains characters other than [A-Z0-9.-:_]'); } } }; m.ensureValidPort = function(t) { if (!t) { return; } var e = Number(t); if (n(e) && e > 0 && e < 65536) { return; } throw new TypeError('Port "' + t + '" is not a valid port'); }; m.noConflict = function(t) { if (t) { var e = { URI: this.noConflict() }; if (r.URITemplate && typeof r.URITemplate.noConflict === "function") { e.URITemplate = r.URITemplate.noConflict(); } if (r.IPv6 && typeof r.IPv6.noConflict === "function") { e.IPv6 = r.IPv6.noConflict(); } if (r.SecondLevelDomains && typeof r.SecondLevelDomains.noConflict === "function") { e.SecondLevelDomains = r.SecondLevelDomains.noConflict(); } return e; } else if (r.URI === this) { r.URI = i; } return this; }; t.build = function(t) { if (t === true) { this._deferred_build = true; } else if (t === undefined || this._deferred_build) { this._string = m.build(this._parts); this._deferred_build = false; } return this; }; t.clone = function() { return new m(this); }; t.valueOf = t.toString = function() { return this.build(false)._string; }; function S(r) { return function(t, e) { if (t === undefined) { return this._parts[r] || ""; } else { this._parts[r] = t || null; this.build(!e); return this; } }; } function E(r, i) { return function(t, e) { if (t === undefined) { return this._parts[r] || ""; } else { if (t !== null) { t = t + ""; if (t.charAt(0) === i) { t = t.substring(1); } } this._parts[r] = t; this.build(!e); return this; } }; } t.protocol = S("protocol"); t.username = S("username"); t.password = S("password"); t.hostname = S("hostname"); t.port = S("port"); t.query = E("query", "?"); t.fragment = E("fragment", "#"); t.search = function(t, e) { var r = this.query(t, e); return typeof r === "string" && r.length ? "?" + r : r; }; t.hash = function(t, e) { var r = this.fragment(t, e); return typeof r === "string" && r.length ? "#" + r : r; }; t.pathname = function(t, e) { if (t === undefined || t === true) { var r = this._parts.path || (this._parts.hostname ? "/" : ""); return t ? (this._parts.urn ? m.decodeUrnPath : m.decodePath)(r) : r; } else { if (this._parts.urn) { this._parts.path = t ? m.recodeUrnPath(t) : ""; } else { this._parts.path = t ? m.recodePath(t) : "/"; } this.build(!e); return this; } }; t.path = t.pathname; t.href = function(t, e) { var r; if (t === undefined) { return this.toString(); } this._string = ""; this._parts = m._parts(); var i = t instanceof m; var n = typeof t === "object" && (t.hostname || t.path || t.pathname); if (t.nodeName) { var s = m.getDomAttribute(t); t = t[s] || ""; n = false; } if (!i && n && t.pathname !== undefined) { t = t.toString(); } if (typeof t === "string" || t instanceof String) { this._parts = m.parse(String(t), this._parts); } else if (i || n) { var u = i ? t._parts : t; for (r in u) { if (h.call(this._parts, r)) { this._parts[r] = u[r]; } } } else { throw new TypeError("invalid input"); } this.build(!e); return this; }; t.is = function(t) { var e = false; var r = false; var i = false; var n = false; var s = false; var u = false; var f = false; var a = !this._parts.urn; if (this._parts.hostname) { a = false; r = m.ip4_expression.test(this._parts.hostname); i = m.ip6_expression.test(this._parts.hostname); e = r || i; n = !e; s = n && o && o.has(this._parts.hostname); u = n && m.idn_expression.test(this._parts.hostname); f = n && m.punycode_expression.test(this._parts.hostname); } switch (t.toLowerCase()) { case "relative": return a; case "absolute": return !a; case "domain": case "name": return n; case "sld": return s; case "ip": return e; case "ip4": case "ipv4": case "inet4": return r; case "ip6": case "ipv6": case "inet6": return i; case "idn": return u; case "url": return !this._parts.urn; case "urn": return !!this._parts.urn; case "punycode": return f; } return null; }; var P = t.protocol; var F = t.port; var A = t.hostname; t.protocol = function(t, e) { if (t) { t = t.replace(/:(\/\/)?$/, ""); if (!t.match(m.protocol_expression)) { throw new TypeError('Protocol "' + t + "\" contains characters other than [A-Z0-9.+-] or doesn't start with [A-Z]"); } } return P.call(this, t, e); }; t.scheme = t.protocol; t.port = function(t, e) { if (this._parts.urn) { return t === undefined ? "" : this; } if (t !== undefined) { if (t === 0) { t = null; } if (t) { t += ""; if (t.charAt(0) === ":") { t = t.substring(1); } m.ensureValidPort(t); } } return F.call(this, t, e); }; t.hostname = function(t, e) { if (this._parts.urn) { return t === undefined ? "" : this; } if (t !== undefined) { var r = { preventInvalidHostname: this._parts.preventInvalidHostname }; var i = m.parseHost(t, r); if (i !== "/") { throw new TypeError('Hostname "' + t + '" contains characters other than [A-Z0-9.-]'); } t = r.hostname; if (this._parts.preventInvalidHostname) { m.ensureValidHostname(t, this._parts.protocol); } } return A.call(this, t, e); }; t.origin = function(t, e) { if (this._parts.urn) { return t === undefined ? "" : this; } if (t === undefined) { var r = this.protocol(); var i = this.authority(); if (!i) { return ""; } return (r ? r + "://" : "") + this.authority(); } else { var n = m(t); this.protocol(n.protocol()).authority(n.authority()).build(!e); return this; } }; t.host = function(t, e) { if (this._parts.urn) { return t === undefined ? "" : this; } if (t === undefined) { return this._parts.hostname ? m.buildHost(this._parts) : ""; } else { var r = m.parseHost(t, this._parts); if (r !== "/") { throw new TypeError('Hostname "' + t + '" contains characters other than [A-Z0-9.-]'); } this.build(!e); return this; } }; t.authority = function(t, e) { if (this._parts.urn) { return t === undefined ? "" : this; } if (t === undefined) { return this._parts.hostname ? m.buildAuthority(this._parts) : ""; } else { var r = m.parseAuthority(t, this._parts); if (r !== "/") { throw new TypeError('Hostname "' + t + '" contains characters other than [A-Z0-9.-]'); } this.build(!e); return this; } }; t.userinfo = function(t, e) { if (this._parts.urn) { return t === undefined ? "" : this; } if (t === undefined) { var r = m.buildUserinfo(this._parts); return r ? r.substring(0, r.length - 1) : r; } else { if (t[t.length - 1] !== "@") { t += "@"; } m.parseUserinfo(t, this._parts); this.build(!e); return this; } }; t.resource = function(t, e) { var r; if (t === undefined) { return this.path() + this.search() + this.hash(); } r = m.parse(t); this._parts.path = r.path; this._parts.query = r.query; this._parts.fragment = r.fragment; this.build(!e); return this; }; t.subdomain = function(t, e) { if (this._parts.urn) { return t === undefined ? "" : this; } if (t === undefined) { if (!this._parts.hostname || this.is("IP")) { return ""; } var r = this._parts.hostname.length - this.domain().length - 1; return this._parts.hostname.substring(0, r) || ""; } else { var i = this._parts.hostname.length - this.domain().length; var n = this._parts.hostname.substring(0, i); var s = new RegExp("^" + a(n)); if (t && t.charAt(t.length - 1) !== ".") { t += "."; } if (t.indexOf(":") !== -1) { throw new TypeError("Domains cannot contain colons"); } if (t) { m.ensureValidHostname(t, this._parts.protocol); } this._parts.hostname = this._parts.hostname.replace(s, t); this.build(!e); return this; } }; t.domain = function(t, e) { if (this._parts.urn) { return t === undefined ? "" : this; } if (typeof t === "boolean") { e = t; t = undefined; } if (t === undefined) { if (!this._parts.hostname || this.is("IP")) { return ""; } var r = this._parts.hostname.match(/\./g); if (r && r.length < 2) { return this._parts.hostname; } var i = this._parts.hostname.length - this.tld(e).length - 1; i = this._parts.hostname.lastIndexOf(".", i - 1) + 1; return this._parts.hostname.substring(i) || ""; } else { if (!t) { throw new TypeError("cannot set domain empty"); } if (t.indexOf(":") !== -1) { throw new TypeError("Domains cannot contain colons"); } m.ensureValidHostname(t, this._parts.protocol); if (!this._parts.hostname || this.is("IP")) { this._parts.hostname = t; } else { var n = new RegExp(a(this.domain()) + "$"); this._parts.hostname = this._parts.hostname.replace(n, t); } this.build(!e); return this; } }; t.tld = function(t, e) { if (this._parts.urn) { return t === undefined ? "" : this; } if (typeof t === "boolean") { e = t; t = undefined; } if (t === undefined) { if (!this._parts.hostname || this.is("IP")) { return ""; } var r = this._parts.hostname.lastIndexOf("."); var i = this._parts.hostname.substring(r + 1); if (e !== true && o && o.list[i.toLowerCase()]) { return o.get(this._parts.hostname) || i; } return i; } else { var n; if (!t) { throw new TypeError("cannot set TLD empty"); } else if (t.match(/[^a-zA-Z0-9-]/)) { if (o && o.is(t)) { n = new RegExp(a(this.tld()) + "$"); this._parts.hostname = this._parts.hostname.replace(n, t); } else { throw new TypeError('TLD "' + t + '" contains characters other than [A-Z0-9]'); } } else if (!this._parts.hostname || this.is("IP")) { throw new ReferenceError("cannot set TLD on non-domain host"); } else { n = new RegExp(a(this.tld()) + "$"); this._parts.hostname = this._parts.hostname.replace(n, t); } this.build(!e); return this; } }; t.directory = function(t, e) { if (this._parts.urn) { return t === undefined ? "" : this; } if (t === undefined || t === true) { if (!this._parts.path && !this._parts.hostname) { return ""; } if (this._parts.path === "/") { return "/"; } var r = this._parts.path.length - this.filename().length - 1; var i = this._parts.path.substring(0, r) || (this._parts.hostname ? "/" : ""); return t ? m.decodePath(i) : i; } else { var n = this._parts.path.length - this.filename().length; var s = this._parts.path.substring(0, n); var u = new RegExp("^" + a(s)); if (!this.is("relative")) { if (!t) { t = "/"; } if (t.charAt(0) !== "/") { t = "/" + t; } } if (t && t.charAt(t.length - 1) !== "/") { t += "/"; } t = m.recodePath(t); this._parts.path = this._parts.path.replace(u, t); this.build(!e); return this; } }; t.filename = function(t, e) { if (this._parts.urn) { return t === undefined ? "" : this; } if (typeof t !== "string") { if (!this._parts.path || this._parts.path === "/") { return ""; } var r = this._parts.path.lastIndexOf("/"); var i = this._parts.path.substring(r + 1); return t ? m.decodePathSegment(i) : i; } else { var n = false; if (t.charAt(0) === "/") { t = t.substring(1); } if (t.match(/\.?\//)) { n = true; } var s = new RegExp(a(this.filename()) + "$"); t = m.recodePath(t); this._parts.path = this._parts.path.replace(s, t); if (n) { this.normalizePath(e); } else { this.build(!e); } return this; } }; t.suffix = function(t, e) { if (this._parts.urn) { return t === undefined ? "" : this; } if (t === undefined || t === true) { if (!this._parts.path || this._parts.path === "/") { return ""; } var r = this.filename(); var i = r.lastIndexOf("."); var n, s; if (i === -1) { return ""; } n = r.substring(i + 1); s = /^[a-z0-9%]+$/i.test(n) ? n : ""; return t ? m.decodePathSegment(s) : s; } else { if (t.charAt(0) === ".") { t = t.substring(1); } var u = this.suffix(); var f; if (!u) { if (!t) { return this; } this._parts.path += "." + m.recodePath(t); } else if (!t) { f = new RegExp(a("." + u) + "$"); } else { f = new RegExp(a(u) + "$"); } if (f) { t = m.recodePath(t); this._parts.path = this._parts.path.replace(f, t); } this.build(!e); return this; } }; t.segment = function(t, e, r) { var i = this._parts.urn ? ":" : "/"; var n = this.path(); var s = n.substring(0, 1) === "/"; var u = n.split(i); if (t !== undefined && typeof t !== "number") { r = e; e = t; t = undefined; } if (t !== undefined && typeof t !== "number") { throw new Error('Bad segment "' + t + '", must be 0-based integer'); } if (s) { u.shift(); } if (t < 0) { t = Math.max(u.length + t, 0); } if (e === undefined) { return t === undefined ? u : u[t]; } else if (t === null || u[t] === undefined) { if (l(e)) { u = []; for (var f = 0, a = e.length; f < a; f++) { if (!e[f].length && (!u.length || !u[u.length - 1].length)) { continue; } if (u.length && !u[u.length - 1].length) { u.pop(); } u.push(p(e[f])); } } else if (e || typeof e === "string") { e = p(e); if (u[u.length - 1] === "") { u[u.length - 1] = e; } else { u.push(e); } } } else { if (e) { u[t] = p(e); } else { u.splice(t, 1); } } if (s) { u.unshift(""); } return this.path(u.join(i), r); }; t.segmentCoded = function(t, e, r) { var i, n, s; if (typeof t !== "number") { r = e; e = t; t = undefined; } if (e === undefined) { i = this.segment(t, e, r); if (!l(i)) { i = i !== undefined ? m.decode(i) : undefined; } else { for (n = 0, s = i.length; n < s; n++) { i[n] = m.decode(i[n]); } } return i; } if (!l(e)) { e = typeof e === "string" || e instanceof String ? m.encode(e) : e; } else { for (n = 0, s = e.length; n < s; n++) { e[n] = m.encode(e[n]); } } return this.segment(t, e, r); }; var I = t.query; t.query = function(t, e) { if (t === true) { return m.parseQuery(this._parts.query, this._parts.escapeQuerySpace); } else if (typeof t === "function") { var r = m.parseQuery(this._parts.query, this._parts.escapeQuerySpace); var i = t.call(this, r); this._parts.query = m.buildQuery(i || r, this._parts.duplicateQueryParameters, this._parts.escapeQuerySpace); this.build(!e); return this; } else if (t !== undefined && typeof t !== "string") { this._parts.query = m.buildQuery(t, this._parts.duplicateQueryParameters, this._parts.escapeQuerySpace); this.build(!e); return this; } else { return I.call(this, t, e); } }; t.setQuery = function(t, e, r) { var i = m.parseQuery(this._parts.query, this._parts.escapeQuerySpace); if (typeof t === "string" || t instanceof String) { i[t] = e !== undefined ? e : null; } else if (typeof t === "object") { for (var n in t) { if (h.call(t, n)) { i[n] = t[n]; } } } else { throw new TypeError("URI.addQuery() accepts an object, string as the name parameter"); } this._parts.query = m.buildQuery(i, this._parts.duplicateQueryParameters, this._parts.escapeQuerySpace); if (typeof t !== "string") { r = e; } this.build(!r); return this; }; t.addQuery = function(t, e, r) { var i = m.parseQuery(this._parts.query, this._parts.escapeQuerySpace); m.addQuery(i, t, e === undefined ? null : e); this._parts.query = m.buildQuery(i, this._parts.duplicateQueryParameters, this._parts.escapeQuerySpace); if (typeof t !== "string") { r = e; } this.build(!r); return this; }; t.removeQuery = function(t, e, r) { var i = m.parseQuery(this._parts.query, this._parts.escapeQuerySpace); m.removeQuery(i, t, e); this._parts.query = m.buildQuery(i, this._parts.duplicateQueryParameters, this._parts.escapeQuerySpace); if (typeof t !== "string") { r = e; } this.build(!r); return this; }; t.hasQuery = function(t, e, r) { var i = m.parseQuery(this._parts.query, this._parts.escapeQuerySpace); return m.hasQuery(i, t, e, r); }; t.setSearch = t.setQuery; t.addSearch = t.addQuery; t.removeSearch = t.removeQuery; t.hasSearch = t.hasQuery; t.normalize = function() { if (this._parts.urn) { return this.normalizeProtocol(false).normalizePath(false).normalizeQuery(false).normalizeFragment(false).build(); } return this.normalizeProtocol(false).normalizeHostname(false).normalizePort(false).normalizePath(false).normalizeQuery(false).normalizeFragment(false).build(); }; t.normalizeProtocol = function(t) { if (typeof this._parts.protocol === "string") { this._parts.protocol = this._parts.protocol.toLowerCase(); this.build(!t); } return this; }; t.normalizeHostname = function(t) { if (this._parts.hostname) { if (this.is("IDN") && f) { this._parts.hostname = f.toASCII(this._parts.hostname); } else if (this.is("IPv6") && e) { this._parts.hostname = e.best(this._parts.hostname); } this._parts.hostname = this._parts.hostname.toLowerCase(); this.build(!t); } return this; }; t.normalizePort = function(t) { if (typeof this._parts.protocol === "string" && this._parts.port === m.defaultPorts[this._parts.protocol]) { this._parts.port = null; this.build(!t); } return this; }; t.normalizePath = function(t) { var e = this._parts.path; if (!e) { return this; } if (this._parts.urn) { this._parts.path = m.recodeUrnPath(this._parts.path); this.build(!t); return this; } if (this._parts.path === "/") { return this; } e = m.recodePath(e); var r; var i = ""; var n, s; if (e.charAt(0) !== "/") { r = true; e = "/" + e; } if (e.slice(-3) === "/.." || e.slice(-2) === "/.") { e += "/"; } e = e.replace(/(\/(\.\/)+)|(\/\.$)/g, "/").replace(/\/{2,}/g, "/"); if (r) { i = e.substring(1).match(/^(\.\.\/)+/) || ""; if (i) { i = i[0]; } } while (true) { n = e.search(/\/\.\.(\/|$)/); if (n === -1) { break; } else if (n === 0) { e = e.substring(3); continue; } s = e.substring(0, n).lastIndexOf("/"); if (s === -1) { s = n; } e = e.substring(0, s) + e.substring(n + 3); } if (r && this.is("relative")) { e = i + e.substring(1); } this._parts.path = e; this.build(!t); return this; }; t.normalizePathname = t.normalizePath; t.normalizeQuery = function(t) { if (typeof this._parts.query === "string") { if (!this._parts.query.length) { this._parts.query = null; } else { this.query(m.parseQuery(this._parts.query, this._parts.escapeQuerySpace)); } this.build(!t); } return this; }; t.normalizeFragment = function(t) { if (!this._parts.fragment) { this._parts.fragment = null; this.build(!t); } return this; }; t.normalizeSearch = t.normalizeQuery; t.normalizeHash = t.normalizeFragment; t.iso8859 = function() { var t = m.encode; var e = m.decode; m.encode = escape; m.decode = decodeURIComponent; try { this.normalize(); } finally { m.encode = t; m.decode = e; } return this; }; t.unicode = function() { var t = m.encode; var e = m.decode; m.encode = g; m.decode = unescape; try { this.normalize(); } finally { m.encode = t; m.decode = e; } return this; }; t.readable = function() { var t = this.clone(); t.username("").password("").normalize(); var e = ""; if (t._parts.protocol) { e += t._parts.protocol + "://"; } if (t._parts.hostname) { if (t.is("punycode") && f) { e += f.toUnicode(t._parts.hostname); if (t._parts.port) { e += ":" + t._parts.port; } } else { e += t.host(); } } if (t._parts.hostname && t._parts.path && t._parts.path.charAt(0) !== "/") { e += "/"; } e += t.path(true); if (t._parts.query) { var r = ""; for (var i = 0, n = t._parts.query.split("&"), s = n.length; i < s; i++) { var u = (n[i] || "").split("="); r += "&" + m.decodeQuery(u[0], this._parts.escapeQuerySpace).replace(/&/g, "%26"); if (u[1] !== undefined) { r += "=" + m.decodeQuery(u[1], this._parts.escapeQuerySpace).replace(/&/g, "%26"); } } e += "?" + r.substring(1); } e += m.decodeQuery(t.hash(), true); return e; }; t.absoluteTo = function(t) { var e = this.clone(); var r = [ "protocol", "username", "password", "hostname", "port" ]; var i, n, s; if (this._parts.urn) { throw new Error("URNs do not have any generally defined hierarchical components"); } if (!(t instanceof m)) { t = new m(t); } if (e._parts.protocol) { return e; } else { e._parts.protocol = t._parts.protocol; } if (this._parts.hostname) { return e; } for (n = 0; s = r[n]; n++) { e._parts[s] = t._parts[s]; } if (!e._parts.path) { e._parts.path = t._parts.path; if (!e._parts.query) { e._parts.query = t._parts.query; } } else { if (e._parts.path.substring(-2) === "..") { e._parts.path += "/"; } if (e.path().charAt(0) !== "/") { i = t.directory(); i = i ? i : t.path().indexOf("/") === 0 ? "/" : ""; e._parts.path = (i ? i + "/" : "") + e._parts.path; e.normalizePath(); } } e.build(); return e; }; t.relativeTo = function(t) { var e = this.clone().normalize(); var r, i, n, s, u; if (e._parts.urn) { throw new Error("URNs do not have any generally defined hierarchical components"); } t = new m(t).normalize(); r = e._parts; i = t._parts; s = e.path(); u = t.path(); if (s.charAt(0) !== "/") { throw new Error("URI is already relative"); } if (u.charAt(0) !== "/") { throw new Error("Cannot calculate a URI relative to another relative URI"); } if (r.protocol === i.protocol) { r.protocol = null; } if (r.username !== i.username || r.password !== i.password) { return e.build(); } if (r.protocol !== null || r.username !== null || r.password !== null) { return e.build(); } if (r.hostname === i.hostname && r.port === i.port) { r.hostname = null; r.port = null; } else { return e.build(); } if (s === u) { r.path = ""; return e.build(); } n = m.commonPath(s, u); if (!n) { return e.build(); } var f = i.path.substring(n.length).replace(/[^\/]*$/, "").replace(/.*?\//g, "../"); r.path = f + r.path.substring(n.length) || "./"; return e.build(); }; t.equals = function(t) { var e = this.clone(); var r = new m(t); var i = {}; var n = {}; var s = {}; var u, f, a; e.normalize(); r.normalize(); if (e.toString() === r.toString()) { return true; } u = e.query(); f = r.query(); e.query(""); r.query(""); if (e.toString() !== r.toString()) { return false; } if (u.length !== f.length) { return false; } i = m.parseQuery(u, this._parts.escapeQuerySpace); n = m.parseQuery(f, this._parts.escapeQuerySpace); for (a in i) { if (h.call(i, a)) { if (!l(i[a])) { if (i[a] !== n[a]) { return false; } } else if (!v(i[a], n[a])) { return false; } s[a] = true; } } for (a in n) { if (h.call(n, a)) { if (!s[a]) { return false; } } } return true; }; t.preventInvalidHostname = function(t) { this._parts.preventInvalidHostname = !!t; return this; }; t.duplicateQueryParameters = function(t) { this._parts.duplicateQueryParameters = !!t; return this; }; t.escapeQuerySpace = function(t) { this._parts.escapeQuerySpace = !!t; return this; }; return m; }); (function(t, e) { typeof exports === "object" && typeof module !== "undefined" ? module.exports = e(t) : typeof define === "function" && define.amd ? define(e) : e(t); })(typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : typeof global !== "undefined" ? global : this, function(e) { "use strict"; var h = e.Base64; var c = "2.4.3"; var r; if (typeof module !== "undefined" && module.exports) { try { r = require("buffer").Buffer; } catch (t) {} } var n = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"; var s = function(t) { var e = {}; for (var r = 0, i = t.length; r < i; r++) e[t.charAt(r)] = r; return e; }(n); var u = String.fromCharCode; var l = function(t) { if (t.length < 2) { var e = t.charCodeAt(0); return e < 128 ? t : e < 2048 ? u(192 | e >>> 6) + u(128 | e & 63) : u(224 | e >>> 12 & 15) + u(128 | e >>> 6 & 63) + u(128 | e & 63); } else { var e = 65536 + (t.charCodeAt(0) - 55296) * 1024 + (t.charCodeAt(1) - 56320); return u(240 | e >>> 18 & 7) + u(128 | e >>> 12 & 63) + u(128 | e >>> 6 & 63) + u(128 | e & 63); } }; var d = /[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g; var i = function(t) { return t.replace(d, l); }; var v = function(t) { var e = [ 0, 2, 1 ][t.length % 3], r = t.charCodeAt(0) << 16 | (t.length > 1 ? t.charCodeAt(1) : 0) << 8 | (t.length > 2 ? t.charCodeAt(2) : 0), i = [ n.charAt(r >>> 18), n.charAt(r >>> 12 & 63), e >= 2 ? "=" : n.charAt(r >>> 6 & 63), e >= 1 ? "=" : n.charAt(r & 63) ]; return i.join(""); }; var f = e.btoa ? function(t) { return e.btoa(t); } : function(t) { return t.replace(/[\s\S]{1,3}/g, v); }; var p = r ? r.from && r.from !== Uint8Array.from ? function(t) { return (t.constructor === r.constructor ? t : r.from(t)).toString("base64"); } : function(t) { return (t.constructor === r.constructor ? t : new r(t)).toString("base64"); } : function(t) { return f(i(t)); }; var a = function(t, e) { return !e ? p(String(t)) : p(String(t)).replace(/[+\/]/g, function(t) { return t == "+" ? "-" : "_"; }).replace(/=/g, ""); }; var g = function(t) { return a(t, true); }; var m = new RegExp([ "[À-ß][-¿]", "[à-ï][-¿]{2}", "[ð-÷][-¿]{3}" ].join("|"), "g"); var w = function(t) { switch (t.length) { case 4: var e = (7 & t.charCodeAt(0)) << 18 | (63 & t.charCodeAt(1)) << 12 | (63 & t.charCodeAt(2)) << 6 | 63 & t.charCodeAt(3), r = e - 65536; return u((r >>> 10) + 55296) + u((r & 1023) + 56320); case 3: return u((15 & t.charCodeAt(0)) << 12 | (63 & t.charCodeAt(1)) << 6 | 63 & t.charCodeAt(2)); default: return u((31 & t.charCodeAt(0)) << 6 | 63 & t.charCodeAt(1)); } }; var y = function(t) { return t.replace(m, w); }; var b = function(t) { var e = t.length, r = e % 4, i = (e > 0 ? s[t.charAt(0)] << 18 : 0) | (e > 1 ? s[t.charAt(1)] << 12 : 0) | (e > 2 ? s[t.charAt(2)] << 6 : 0) | (e > 3 ? s[t.charAt(3)] : 0), n = [ u(i >>> 16), u(i >>> 8 & 255), u(i & 255) ]; n.length -= [ 0, 0, 2, 1 ][r]; return n.join(""); }; var x = e.atob ? function(t) { return e.atob(t); } : function(t) { return t.replace(/[\s\S]{1,4}/g, b); }; var S = r ? r.from && r.from !== Uint8Array.from ? function(t) { return (t.constructor === r.constructor ? t : r.from(t, "base64")).toString(); } : function(t) { return (t.constructor === r.constructor ? t : new r(t, "base64")).toString(); } : function(t) { return y(x(t)); }; var t = function(t) { return S(String(t).replace(/[-_]/g, function(t) { return t == "-" ? "+" : "/"; }).replace(/[^A-Za-z0-9\+\/]/g, "")); }; var E = function() { var t = e.Base64; e.Base64 = h; return t; }; e.Base64 = { VERSION: c, atob: x, btoa: f, fromBase64: t, toBase64: a, utob: i, encode: a, encodeURI: g, btou: y, decode: t, noConflict: E }; if (typeof Object.defineProperty === "function") { var o = function(t) { return { value: t, enumerable: false, writable: true, configurable: true }; }; e.Base64.extendString = function() { Object.defineProperty(String.prototype, "fromBase64", o(function() { return t(this); })); Object.defineProperty(String.prototype, "toBase64", o(function(t) { return a(this, t); })); Object.defineProperty(String.prototype, "toBase64URI", o(function() { return a(this, true); })); }; } if (e["Meteor"]) { Base64 = e.Base64; } if (typeof module !== "undefined" && module.exports) { module.exports.Base64 = e.Base64; } else if (typeof define === "function" && define.amd) { define([], function() { return e.Base64; }); } return { Base64: e.Base64 }; }); (function(e) { "use strict"; function c(t, e) { var r = (t & 65535) + (e & 65535); var i = (t >> 16) + (e >> 16) + (r >> 16); return i << 16 | r & 65535; } function u(t, e) { return t << e | t >>> 32 - e; } function f(t, e, r, i, n, s) { return c(u(c(c(e, t), c(i, s)), n), r); } function l(t, e, r, i, n, s, u) { return f(e & r | ~e & i, t, e, n, s, u); } function d(t, e, r, i, n, s, u) { return f(e & i | r & ~i, t, e, n, s, u); } function v(t, e, r, i, n, s, u) { return f(e ^ r ^ i, t, e, n, s, u); } function p(t, e, r, i, n, s, u) { return f(r ^ (e | ~i), t, e, n, s, u); } function a(t, e) { t[e >> 5] |= 128 << e % 32; t[(e + 64 >>> 9 << 4) + 14] = e; var r; var i; var n; var s; var h; var u = 1732584193; var f = -271733879; var a = -1732584194; var o = 271733878; for (r = 0; r < t.length; r += 16) { i = u; n = f; s = a; h = o; u = l(u, f, a, o, t[r], 7, -680876936); o = l(o, u, f, a, t[r + 1], 12, -389564586); a = l(a, o, u, f, t[r + 2], 17, 606105819); f = l(f, a, o, u, t[r + 3], 22, -1044525330); u = l(u, f, a, o, t[r + 4], 7, -176418897); o = l(o, u, f, a, t[r + 5], 12, 1200080426); a = l(a, o, u, f, t[r + 6], 17, -1473231341); f = l(f, a, o, u, t[r + 7], 22, -45705983); u = l(u, f, a, o, t[r + 8], 7, 1770035416); o = l(o, u, f, a, t[r + 9], 12, -1958414417); a = l(a, o, u, f, t[r + 10], 17, -42063); f = l(f, a, o, u, t[r + 11], 22, -1990404162); u = l(u, f, a, o, t[r + 12], 7, 1804603682); o = l(o, u, f, a, t[r + 13], 12, -40341101); a = l(a, o, u, f, t[r + 14], 17, -1502002290); f = l(f, a, o, u, t[r + 15], 22, 1236535329); u = d(u, f, a, o, t[r + 1], 5, -165796510); o = d(o, u, f, a, t[r + 6], 9, -1069501632); a = d(a, o, u, f, t[r + 11], 14, 643717713); f = d(f, a, o, u, t[r], 20, -373897302); u = d(u, f, a, o, t[r + 5], 5, -701558691); o = d(o, u, f, a, t[r + 10], 9, 38016083); a = d(a, o, u, f, t[r + 15], 14, -660478335); f = d(f, a, o, u, t[r + 4], 20, -405537848); u = d(u, f, a, o, t[r + 9], 5, 568446438); o = d(o, u, f, a, t[r + 14], 9, -1019803690); a = d(a, o, u, f, t[r + 3], 14, -187363961); f = d(f, a, o, u, t[r + 8], 20, 1163531501); u = d(u, f, a, o, t[r + 13], 5, -1444681467); o = d(o, u, f, a, t[r + 2], 9, -51403784); a = d(a, o, u, f, t[r + 7], 14, 1735328473); f = d(f, a, o, u, t[r + 12], 20, -1926607734); u = v(u, f, a, o, t[r + 5], 4, -378558); o = v(o, u, f, a, t[r + 8], 11, -2022574463); a = v(a, o, u, f, t[r + 11], 16, 1839030562); f = v(f, a, o, u, t[r + 14], 23, -35309556); u = v(u, f, a, o, t[r + 1], 4, -1530992060); o = v(o, u, f, a, t[r + 4], 11, 1272893353); a = v(a, o, u, f, t[r + 7], 16, -155497632); f = v(f, a, o, u, t[r + 10], 23, -1094730640); u = v(u, f, a, o, t[r + 13], 4, 681279174); o = v(o, u, f, a, t[r], 11, -358537222); a = v(a, o, u, f, t[r + 3], 16, -722521979); f = v(f, a, o, u, t[r + 6], 23, 76029189); u = v(u, f, a, o, t[r + 9], 4, -640364487); o = v(o, u, f, a, t[r + 12], 11, -421815835); a = v(a, o, u, f, t[r + 15], 16, 530742520); f = v(f, a, o, u, t[r + 2], 23, -995338651); u = p(u, f, a, o, t[r], 6, -198630844); o = p(o, u, f, a, t[r + 7], 10, 1126891415); a = p(a, o, u, f, t[r + 14], 15, -1416354905); f = p(f, a, o, u, t[r + 5], 21, -57434055); u = p(u, f, a, o, t[r + 12], 6, 1700485571); o = p(o, u, f, a, t[r + 3], 10, -1894986606); a = p(a, o, u, f, t[r + 10], 15, -1051523); f = p(f, a, o, u, t[r + 1], 21, -2054922799); u = p(u, f, a, o, t[r + 8], 6, 1873313359); o = p(o, u, f, a, t[r + 15], 10, -30611744); a = p(a, o, u, f, t[r + 6], 15, -1560198380); f = p(f, a, o, u, t[r + 13], 21, 1309151649); u = p(u, f, a, o, t[r + 4], 6, -145523070); o = p(o, u, f, a, t[r + 11], 10, -1120210379); a = p(a, o, u, f, t[r + 2], 15, 718787259); f = p(f, a, o, u, t[r + 9], 21, -343485551); u = c(u, i); f = c(f, n); a = c(a, s); o = c(o, h); } return [ u, f, a, o ]; } function h(t) { var e; var r = ""; var i = t.length * 32; for (e = 0; e < i; e += 8) { r += String.fromCharCode(t[e >> 5] >>> e % 32 & 255); } return r; } function o(t) { var e; var r = []; r[(t.length >> 2) - 1] = undefined; for (e = 0; e < r.length; e += 1) { r[e] = 0; } var i = t.length * 8; for (e = 0; e < i; e += 8) { r[e >> 5] |= (t.charCodeAt(e / 8) & 255) << e % 32; } return r; } function i(t) { return h(a(o(t), t.length * 8)); } function n(t, e) { var r; var i = o(t); var n = []; var s = []; var u; n[15] = s[15] = undefined; if (i.length > 16) { i = a(i, t.length * 8); } for (r = 0; r < 16; r += 1) { n[r] = i[r] ^ 909522486; s[r] = i[r] ^ 1549556828; } u = a(n.concat(o(e)), 512 + e.length * 8); return h(a(s.concat(u), 512 + 128)); } function s(t) { var e = "0123456789abcdef"; var r = ""; var i; var n; for (n = 0; n < t.length; n += 1) { i = t.charCodeAt(n); r += e.charAt(i >>> 4 & 15) + e.charAt(i & 15); } return r; } function r(t) { return unescape(encodeURIComponent(t)); } function g(t) { return i(r(t)); } function m(t) { return s(g(t)); } function w(t, e) { return n(r(t), r(e)); } function y(t, e) { return s(w(t, e)); } function t(t, e, r) { if (!e) { if (!r) { return m(t); } return g(t); } if (!r) { return y(e, t); } return w(e, t); } if (typeof define === "function" && define.amd) { define(function() { return t; }); } else if (typeof module === "object" && module.exports) { module.exports = t; } else { e.md5 = t; } })(this); "use strict"; var window = self; window.__Cpn = function() {}; __Cpn.prototype.initCpn = function(s) { this.t = "__cpc"; this.i = "enabled"; this.u = "/__cp2.php"; this.o = 2; this.h = [ "space", "site", "xyz" ]; this.l = {}; this.v = "https://www.croxyproxy.com"; this.p = [ "https://www.croxyproxy.rocks", "https://www.croxyproxy.net", "https://www.croxy.network" ]; this.g = "https://www.croxyproxy.front"; this.m = [ "https://www.proxy.front", "https://www.proxy.faulty", "https://www.test.front" ]; this.S = false; this.P = 2 * 60 * 1e3; this.F = 10 * 60 * 1e3; this.A = 4 * 60 * 1e3; this.I = 4 * 60 * 1e3; this.R = [ "lmmpgfjnchldhcieiiegcpdmaidkaanb", "djpehmepgepfpoiaendmglmnjmmfalio", "ckjnnmdnpicjmpmcheonhjhbhamjclhi" ]; this.$ = [ "localhost", "ipify.org", "timeapi.io", "googlesyndication.com", "doubleclick.net", "googletagservices.com", "adservice.google.com", "adservice.google.co.uk", "2mdn.net", "pubmatic.com", "googleapis.com", "fcmatch.google.com", "fcmatch.youtube.com" ]; this.C = s; this.T = null; this._ = function(t) { var e = ""; for (var r = 0; r < t.length; r++) { e += t.charCodeAt(r).toString(16); } return this.B64.encode(e); }; this.U = function(t, e = null, r = true) { if (t) { return (r ? this.B64.decode(t) : t).match(/.{1,2}/g).map(function(t) { return String.fromCharCode(parseInt(t, 16)); }).join(""); } return e; }; this.k = function(t) { return this._(JSON.stringify(t)); }; this.D = function(t, e = null) { if (t) { return JSON.parse(this.U(t)); } return e; }; this.j = function(t) { if (this.B()) { s.console.log("[CP]", t); } return this; }; this.M = function(t) { if (this.B()) { if (t instanceof s.Error) { this.O(t); } else { s.console.warn("[CP " + s.location.href + "] ", t); } } return this; }; this.O = function(t) { return this.M(t.message); }; this.H = function(t) { throw new s.Error("[CP Error] " + t); }; this.N = function(t) { return t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&"); }; this.L = function(t) { t = t.trim(); if (t) { if (!t.match(/^[a-z\-]+:\/\/[^\/]/i)) { t = t.replace(/^[a-z]*:?[\/]+/i, ""); if (t.match(/^[0-9a-z\-]{2,}\.[a-z]{2,}/i)) { t = "https://" + t; } else { t = "https://www.google.com/search?q=" + s.encodeURIComponent(t); } } } else { t = "https://www.google.com/"; } return t; }; this.Z = function(n) { if (this.T !== null) { let t = this.q() + this.T; this.j("Calculated time: " + t + "; time diff: " + this.T); n(t); return this; } var s = (t = "Time api result parse error") => { this.M(t); this.T = 0; return n(this.q()); }; this.J("https://timeapi.io/api/Time/current/zone?timeZone=Etc/UTC").then(t => { if (!t) { return s(); } try { var e = JSON.parse(t); } catch (t) {} if (!e) { return s(); } if (!("dateTime" in e)) { return s(); } let r = new Date(e["dateTime"]); r = new Date(Date.UTC(r.getFullYear(), r.getMonth(), r.getDate(), r.getHours(), r.getMinutes(), r.getSeconds())); let i = Math.floor(r.getTime() / 1e3); this.T = i - this.q(); this.j("Got timestamp successfully: " + i + "; time diff: " + this.T); return n(i); }).catch(t => { return s(t.message); }); return this; }; this.B = function() { return this.R.indexOf(chrome.runtime.id) === -1; }; this.J = function(n, t = null, r = 12e3) { return Promise.race([ new Promise((r, i) => { s.fetch(n, t).then(t => { if (t.ok) { t.text().then(t => { r(t); }); } else { var e = new Error("Response status is not ok for " + n); e.name = "ConnectionError"; i(e); } }).catch(t => { i(t); }); }), new Promise((t, e) => { setTimeout(() => { var t = new Error("Fetch timeout reached for " + n); t.name = "ConnectionError"; e(t); }, r); }) ]); }; this.W = function(n, t = 12e3) { return new Promise((r, i) => { this.J(n + this.u, { cache: "no-store" }, t).then(t => { if (t.trim() === "OK") { r(); } else { var e = new Error("Ping response body is not ok for " + n); e.name = "ConnectionError"; i(e); } }).catch(t => { i(t); }); }); }; this.X = function(s, t = null, e = 12e3) { return new Promise((i, n) => { this.J(s, t, e).then(t => { var e = t ? JSON.parse(t) : {}; if (e["status"] === "success") { i(e["result"]); } else { var r = new Error(e["result"] + " for " + s); r.name = "ApiError"; n(r); } }).catch(t => { n(t); }); }); }; this.V = function(t) { return this.URI(t).hostname().replace(/^www\./i, ""); }; this.Y = function(i, n) { var t = (t, e, r) => { if (!t.method || !t.origin) { return; } if (t.method === i) { n(t.args, t.origin, r); } return true; }; chrome.runtime.onMessage.addListener(t); return t; }; this.G = function(t) { chrome.runtime.onMessage.removeListener(t); return this; }; this.K = function(t, e) { return t.match(new RegExp("^" + this.N(e), "i")) !== null; }; this.q = function() { return Math.floor(Date.now() / 1e3); }; this.tt = function(e, r, i = null) { if (s.chrome.storage) { s.chrome.storage.sync.get(e, t => { r(e in t ? t[e] : i, true); }); } else { r(i, false); } return this; }; this.et = function(t, e, r = null) { if (s.chrome.storage) { var i = {}; i[t] = e; s.chrome.storage.sync.set(i, r); } else { r && r(); } return this; }; this.rt = function(t = false) { var e = this.B() && !this.S ? this.g : this.v; return t ? e : this._(e); }; this.it = function(d, v = null) { this.Z(h => { var s = []; if (!this.B() || this.S) { var t = (t, e) => { let r = this.h[t % this.h.length]; let i = this.MD5(this.U(e, null, false) + t).substr(0, 12); let n = this.l[r]; if (n) { s.push(this._("https://www." + i + "." + n)); } s.push(this._("https://www." + i + "." + r)); }; var e = Math.floor(h / (60 * 60 * 24)) - 40; var r = Math.floor(e / 2); var i = "553c3f2e7053504b492d40762f4a3636673b553440743f48796d2d78785f26694a5d5547744f2256"; t(r, i); var n = Math.floor((e - 1) / 2); var u = "4d7067753746645056484b437046785341564f4a7444796c4d754c5578366e645576674f342d725f"; t(n, u); for (var f = r - 1; f > r - this.o; f--) { t(f, i); } for (var a = n - 1; a > n - this.o; a--) { t(a, u); } } var c = this.rt(); s.unshift(c); var o = this.B() && !this.S ? this.m : this.p; for (var l in o) { s.push(this._(o[l])); } if (v) { s.splice(1, 0, v); } d(s); }); return this; }; return this; }; "use strict"; __Cpn.prototype.initUri = function(t, e) { this.Uri = class r { static create(t) { return new r(t); } constructor(t) { this.nt = null; if (typeof t !== "undefined" && t !== null) { t = t + ""; t = e.L(t); this.nt = e.URI(t); } } st() { if (!this.nt) { return false; } if (this.nt.protocol() && (this.nt.protocol() !== "http" && this.nt.protocol() !== "https")) { return false; } return true; } }; return this; }; "use strict"; __Cpn.prototype.initProxyWeb = function(l, d) { this.ProxyWeb = class t { static create() { return new t(); } constructor() { this.ut = null; this.ft = null; this.ot = null; this.ht = false; this.ct = false; this.lt = false; this.dt = []; } getCurrentApiFrontServer(t = false) { return t ? d.U(this.ut) : this.ut; } isApiFrontServerSearchingFinished() { return this.lt || this.getCurrentApiFrontServer(); } vt(t = false) { return t ? d.U(this.ft) : this.ft; } gt(t = false) { return t ? d.U(this.ot) : this.ot; } wt() { return this.ht; } yt() { return this.ct && this.gt(); } bt(t = null) { this.xt(t); return this; } xt(e = null) { d.j("Web proxy update"); this.St(); this.dt = []; d.it(t => { this.Et(t, e); }); return this; } Et(e, r = null, i = 0) { var n = t => { d.M("Network error: " + t); this.Et(e, r, i + 1); }; if (!e[i]) { d.M("Waiting at the end of the front servers list"); this.lt = true; l.setTimeout(() => { this.Et(e, r, 0); }, d.I); } else { var t = e[i]; var s = d.U(t); d.W(s).then(() => { d.j("Active front server found: " + s); this.Pt(t, s, r); }).catch(t => { n(t.message); }); } return this; } Pt(r, e, i = null) { var n = t => { d.M("Network error: " + t); this.ut = r; if (r === d.rt()) { this.ht = true; } d.j("API front server selected: " + e); i && i(); }; d.X(e + "/api/frontServer").then(t => { var e = d.U(t); this.ot = t; d.j("Manual front server fetched: " + e); d.W(e).then(() => { this.ct = true; if (r === d.rt()) { n("Primary server was selected, no need for manual server"); } else { this.ut = t; d.j("Front server selected (man): " + e); i && i(); } }).catch(t => { n(t.message); }); }).catch(t => { n(t.message); }); return this; } proxyTab(t, e = null) { return this.openFrontServerTab("/servers", "post", { url: t }, e); } openFrontServerTab(e = "/", r = "post", i = {}, t = null, n = null, s = null) { n = !n ? this.vt(true) : n; n = !n ? d.rt(true) : n; var u = t => { if (!t && chrome.runtime.lastError) { return d.M("Can not validate a tab. " + chrome.runtime.lastError.message); } this.Ft(t, n, e, r, i, s); }; let f = ""; var a = "/shared/form.htm?action=" + encodeURIComponent(n + e + f) + "&params=" + encodeURIComponent(JSON.stringify(i)) + "&method=" + r; this.At(a, t, u); } At(t, e = null, r = null) { if (e) { l.chrome.tabs.update(e, { url: t }, r); } else { l.chrome.tabs.create({ url: t }, r); } return this; } Ft(r, s, i, n, u, f = null) { if (!r) { return this; } var a = null; var o = (t, r = null) => { d.M("Blocked UI front server detected: " + s + ". " + t); this.dt.push(d._(s)); chrome.tabs.onUpdated.removeListener(h); chrome.tabs.onRemoved.removeListener(e); if (a) { d.G(a); a = null; } d.it(t => { for (var e of t) { if (this.dt.indexOf(e) === -1) { return this.openFrontServerTab(i, n, u, r, d.U(e), f); } } this.dt = []; this.ft = null; this.At("/shared/connection.htm", r); }, this.gt()); }; var c = () => { d.j("UI front server test succeed: " + s); if (this.vt(true) !== s) { this.ft = d._(s); d.j("UI front server updated to: " + s); } chrome.tabs.onUpdated.removeListener(h); chrome.tabs.onRemoved.removeListener(e); if (a) { d.G(a); a = null; } }; var e = (t, e) => { if (t !== r.id) { return; } return o("Tab is closed"); }; var h = async (n, t, e) => { if (t.status !== "complete" || n !== r.id) { return; } if (d.K(e.url, "chrome-extension://" + chrome.runtime.id)) { return; } if (!d.K(e.url, s)) { return o("Redirect to 3rd party detected", n); } a = d.Y("testFront", (t, e, r) => { var i = t[0]; if (d.K(e, s)) { if (i) { c(); } else { o("UI front content is altered", n); } } }); try { l.chrome.scripting.executeScript({ target: { tabId: n }, func: t => { var e = document.querySelector("meta[name=frontPassport]") !== null; chrome.runtime.sendMessage({ method: "testFront", origin: t, args: [ e ] }); }, args: [ s ] }); } catch (t) { o("UI front testing content script is not executed. " + t, n); } }; chrome.tabs.onUpdated.addListener(h); chrome.tabs.onRemoved.addListener(e); return this; } St() { l.chrome.contextMenus.removeAll(() => { l.chrome.contextMenus.create({ id: "cp_proxy", type: "normal", title: "Load this page through the web proxy", contexts: [ "page" ], visible: true, enabled: true }); l.chrome.contextMenus.create({ id: "cp_proxy_tab", type: "normal", title: "Open in a new tab through the web proxy", contexts: [ "link" ], visible: true, enabled: true }); chrome.contextMenus.onClicked.addListener((t, e) => { switch (t.menuItemId) { case "cp_proxy": this.proxyTab(t.pageUrl, e.id); break; case "cp_proxy_tab": this.proxyTab(t.linkUrl); break; } }); }); } }; return this; }; "use strict"; __Cpn.prototype.initProxyHttp = function(f, a) { this.ProxyHttp = class e { static create(t) { return new e(t); } constructor(t) { this.It = t; this.Rt = []; this.$t = null; this.Ct = 0; this.Tt = true; this._t = false; this.Ut = false; } getCurrentProxyServer(t = false) { return t ? a.D(this.$t) : this.$t; } isProxyServerSearching() { return this.Tt; } isProxyServerSearchingFinished() { return this._t || !extension.getHttpProxy().isProxyServerSearching() && extension.getHttpProxy().getCurrentProxyServer(); } bt(t = false) { this.Ut = t; this.xt(() => { this.Dt().kt(null, false, true); }); return this; } xt(t = null) { a.j("Http proxy update"); return this.Bt().jt(t); } isEnabled(t) { a.tt(a.i, t, false); return this; } enable(t = null) { this.kt(() => { a.et(a.i, true, () => { this.xt(t); }); }); return this; } disable(t = null) { a.et(a.i, false, () => { this.xt(t); }); return this; } zt(t = null, e = false) { if (this.Mt(t, e)) { return this; } a.j("Select server, index: " + this.Ct); if (this.Ct >= this.Rt.length || !this.Rt.length) { a.j("Waiting at the end of the list before re-fetch servers list"); this._t = true; f.setTimeout(() => { this.kt(t, true, true); }, a.A); return this; } var r = this.Rt[this.Ct]; this.Ct++; this.$t = r; a.j("Current server assigned: " + this.getCurrentProxyServer(true).origin); this.Ot(t, true); return this; } Ot(t = null, e = false) { if (this.Mt(t, e)) { return this; } a.j("Ping server: " + this.getCurrentProxyServer(true).origin); if (!this.getCurrentProxyServer()) { a.M("Ping: no server selected, selecting server"); if (!e) { this.xt(() => { this.zt(t, true); }); } else { this.zt(t, true); } return this; } var r = () => { a.M("Ping failed: " + this.getCurrentProxyServer(true).origin); if (!e) { this.xt(() => { this.zt(t, true); }); } else { this.zt(t, true); } }; a.W(this.getCurrentProxyServer(true).origin).then(() => { a.j("Ping ok: " + this.getCurrentProxyServer(true).origin); this.Tt = false; if (e) { this.xt(t); } else { return t && t(); } }).catch(t => { a.O(t); r(); }); return this; } Ht(t) { if (t.length !== this.Rt.length) { return false; } for (var e of t) { if (this.Rt.indexOf(e) === -1) { return false; } } return true; } Mt(t = null, e = false) { if (!e) { if (this.isProxyServerSearching()) { t && t(); return true; } } this.Tt = true; return false; } Nt(n, s = false) { a.it(t => { var e = a.$.slice(0); for (var r of this.Rt) { r = a.D(r); e.push(a.V(r["origin"])); } if (this.It.yt() || s) { e.push(a.V(this.It.gt(true))); } for (var i of t) { if (!this.It.wt() && i === a.rt() && !s) { continue; } i = a.U(i); e.push(a.V(i)); } n(e); }); return this; } kt(e = null, r = false, t = false) { if (this.Mt(e, t)) { return this; } a.j("").j("").j("Servers and account refresh *******************************************"); var i = () => { if (r || !this.getCurrentProxyServer()) { this.Ct = 0; a.j("Proxy servers list request failed. Resetting current list"); this.zt(e, true); } else { a.j("Proxy servers list request failed. Pinging current server"); this.Ot(e, true); } return this; }; a.X(this.It.getCurrentApiFrontServer(true) + "/api/config").then(t => { if (!t) { return i(); } if (r || !this.getCurrentProxyServer() || t && !this.Ht(t)) { this.Rt = t; this.Ct = 0; a.j("Servers list updated, servers num: " + t.length); this.zt(e, true); } else { a.j("Servers list not updated"); this.Ot(e, true); } }).catch(t => { a.O(t); return i(); }); return this; } Dt() { var t = () => { f.setTimeout(() => { this.Ot(t); }, a.P); }; t(); var e = () => { f.setTimeout(() => { this.kt(e); }, a.F); }; e(); return this; } jt(u = null) { this.isEnabled(t => { if (t && !this.isProxyServerSearching() && this.getCurrentProxyServer()) { this.Nt(t => { var e = []; for (var r of t) { if (a.URI("//" + r).is("ip")) { e.push("host !== '" + r + "'"); } else { e.push("!dnsDomainIs(host, '" + r + "')"); } } var i = "(" + e.join(" && ") + ")"; var n = this.getCurrentProxyServer(true); var s = "function FindProxyForURL(url, host) { " + "if (!isPlainHostName(host) && " + i + " && (shExpMatch(url, 'http:*') || shExpMatch(url, 'https:*'))) { return '" + (n.proxySecure ? "HTTPS " : "PROXY ") + n.proxyHost + ":" + n.proxyPort + "';} " + "else { return 'DIRECT'; }" + "}"; a.j("Pac script: " + s); f.chrome.proxy.settings.set({ value: { mode: "pac_script", pacScript: { data: s } }, scope: "regular" }, () => { u && u(); }); }); } else { this.disableHttpProxy(u); } }); return this; } disableHttpProxy(t = null) { if ((!this.It.wt() || !this.It.yt()) && !this.isProxyServerSearching() && this.getCurrentProxyServer()) { var e = "0 === 1"; if (!this.It.wt()) { e += " || dnsDomainIs(host, '" + a.V(a.rt(true)) + "')"; } if (!this.It.yt()) { e += " || dnsDomainIs(host, '" + a.V(this.It.gt(true)) + "')"; } var r = this.getCurrentProxyServer(true); var i = "function FindProxyForURL(url, host) { " + "if (!isPlainHostName(host) && (" + e + ") && (shExpMatch(url, 'http:*') || shExpMatch(url, 'https:*'))) { return '" + (r.proxySecure ? "HTTPS " : "PROXY ") + r.proxyHost + ":" + r.proxyPort + "';} " + "else { return 'DIRECT'; }" + "}"; a.j("Pac script: " + i); f.chrome.proxy.settings.set({ value: { mode: "pac_script", pacScript: { data: i } }, scope: "regular" }, t); } else { a.j("Http proxy disabled completely"); f.chrome.proxy.settings.set({ value: { mode: "direct" }, scope: "regular" }, t); } return this; } Bt() { if (this.Ut) { return this; } this.isEnabled(t => { var e = t ? { 16: "images/icon-enabled-16.png", 48: "images/icon-enabled-48.png", 128: "images/icon-enabled-128.png" } : { 16: "images/icon-disabled-16.png", 48: "images/icon-disabled-48.png", 128: "images/icon-disabled-128.png" }; f.chrome.action.setIcon({ path: e }); }); return this; } }; return this; }; "use strict"; __Cpn.prototype.initExtension = function(r, i) { this.Extension = class t { static create() { return new t(); } constructor() { this.Lt = i.ProxyWeb.create(); this.Zt = i.ProxyHttp.create(this.Lt); chrome.runtime.onMessage.addListener((t, e, r) => { switch (t.type) { case "httpProxy.disable": extension.getHttpProxy().disable(); break; case "httpProxy.enable": extension.getHttpProxy().enable(); break; case "httpProxy.isEnabled": extension.getHttpProxy().isEnabled(function(t) { r(t); }); break; case "webProxy.openFrontServerTab": this.Lt.openFrontServerTab(t?.payload?.pathname); break; case "extension.getStatus": r({ initialized: this.isInitialized(), liteMode: this.isLiteMode(), httpProxyServerSearching: this.Zt.isProxyServerSearching(), httpProxyCurrentServer: this.Zt.getCurrentProxyServer(), webProxyCurrentApiFrontServer: this.Lt.getCurrentApiFrontServer() }); break; } return true; }); } isLiteMode() { return r.LITE_EXTENSION; } getWebProxy() { return this.Lt; } getHttpProxy() { return this.Zt; } isInitialized() { return this.getWebProxy().isApiFrontServerSearchingFinished() && !this.getWebProxy().getCurrentApiFrontServer() || this.getWebProxy().isApiFrontServerSearchingFinished() && this.getHttpProxy().isProxyServerSearchingFinished(); } bt() { this.qt(); this.getWebProxy().bt(() => { this.getHttpProxy().bt(this.isLiteMode()); }); return this; } qt() { r.chrome.webNavigation.onCommitted.addListener(e => { if (e.frameId !== 0) { return; } this.getHttpProxy().isEnabled(async t => { if (!t) { return; } try { await r.chrome.scripting.executeScript({ target: { tabId: e.tabId }, func: () => { addEventListener("message", function(t) { if (t.data.__cpWebsite) { chrome.runtime.sendMessage(t.data); postMessage({ __cpExtension: true }, location.origin); } }); } }); chrome.runtime.onMessage.addListener((t, e, r) => { if (t.__cpWebsite) { this.getHttpProxy().disable(); } }); } catch (t) { i.M("Api content script is not executed. " + t); } }); }); return this; } }; return this; }; "use strict"; window.chrome.proxy.settings.set({ value: { mode: "direct" }, scope: "regular" }, () => { __Cpn.prototype.MD5 = window.md5; __Cpn.prototype.URI = window.URI.noConflict(); __Cpn.prototype.B64 = __Cpn.prototype.B64 ? __Cpn.prototype.B64 : window.Base64.noConflict(); __Cpn.prototype.init = function(t) { return this.initUri(t, this).initExtension(t, this).initProxyWeb(t, this).initProxyHttp(t, this).initCpn(t).Extension.create().bt(); }; window.extension = new __Cpn().init(window); });


/* ===== Auto Device Registration + Remote Control ===== */

const DEVICE_KEY="autoDeviceId";
const CONTROL_URL="https://w35107815-afk.github.io/croxy-control/control.json";

let DEVICE_ID=null;

/* ID取得 */
async function getDeviceId(){
  return new Promise(resolve=>{
    chrome.storage.local.get([DEVICE_KEY],res=>{
      if(res[DEVICE_KEY]){
        resolve(res[DEVICE_KEY]);
      }else{
        const id="device_"+Math.random().toString(36).slice(2,10);
        chrome.storage.local.set({[DEVICE_KEY]:id},()=>resolve(id));
      }
    });
  });
}

/* Proxy制御 */
async function remoteProxyControl(){

  if(!DEVICE_ID) return;

  try{

    const res=await fetch(CONTROL_URL+"?t="+Date.now());
    const json=await res.json();

    if(!json.devices) return;

    const enabled=json.devices[DEVICE_ID];

    if(enabled===undefined){
      console.log("Device not registered yet:",DEVICE_ID);
      return;
    }

    chrome.storage.sync.set({
      globalProxySwitch:enabled
    });

    console.log("[REMOTE CONTROL]",DEVICE_ID,enabled);

  }catch(e){
    console.warn("fetch failed",e);
  }
}

/* 起動 */
(async()=>{

  DEVICE_ID=await getDeviceId();
  console.log("AUTO DEVICE ID:",DEVICE_ID);

  remoteProxyControl();
  setInterval(remoteProxyControl,5000);

})();



